<?xml version="1.0" encoding="utf-8"?>

<Page
    x:Class="CompiLiasse_Sharp.Views.SettingsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:models="using:CompiLiasse_Sharp.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <ScrollViewer
        HorizontalScrollBarVisibility="Disabled"
        VerticalScrollBarVisibility="Auto"
        HorizontalContentAlignment="Stretch">

        <!-- Grid direct => stretch fiable -->
        <Grid HorizontalAlignment="Stretch">
            <StackPanel
                Spacing="16"
                Padding="24"
                HorizontalAlignment="Stretch">

                <!-- Titre -->
                <TextBlock
                    Text="Paramètres"
                    FontSize="32"
                    FontWeight="SemiBold"
                    HorizontalAlignment="Left" />

                <!-- Carte : Configuration active -->
                <Border
                    HorizontalAlignment="Stretch"
                    Padding="16"
                    CornerRadius="12"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1">

                    <Expander
                        IsExpanded="True"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch">

                        <Expander.Header>
                            <!-- + d'air vertical dans le header -->
                            <Border Padding="0,8,0,8">
                                <Grid
                                    ColumnDefinitions="Auto,*"
                                    VerticalAlignment="Center"
                                    HorizontalAlignment="Stretch">
                                    <FontIcon Glyph="&#xE713;" FontSize="18" Margin="0,0,12,0" />

                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock
                                            Text="Configuration"
                                            FontSize="18"
                                            FontWeight="SemiBold" />
                                        <TextBlock
                                            Text="Choisissez un profil et paramétrez les chemins"
                                            Opacity="0.75" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Expander.Header>

                        <StackPanel
                            Spacing="14"
                            Margin="0,12,0,0"
                            HorizontalAlignment="Stretch">

                            <!-- Ligne : Combo + boutons (responsive sur la largeur réelle de la carte) -->
                            <Grid
                                x:Name="ProfileRowRoot"
                                SizeChanged="ProfileRowRoot_SizeChanged"
                                Loaded="ProfileRowRoot_Loaded">

                                <!-- Layout LARGE -->
                                <Grid
                                    x:Name="ProfileRowWide"
                                    ColumnDefinitions="*,Auto,Auto,Auto"
                                    ColumnSpacing="8"
                                    Visibility="Visible">

                                    <ComboBox
                                        ItemsSource="{Binding Profiles}"
                                        SelectedItem="{Binding SelectedProfile, Mode=TwoWay}"
                                        DisplayMemberPath="Name"
                                        PlaceholderText="Choisir une configuration..."
                                        MinWidth="220" />

                                    <Button
                                        Grid.Column="1"
                                        Content="Enregistrer sous…"
                                        Click="SaveAs_Click" />

                                    <Button
                                        Grid.Column="2"
                                        Content="Ajouter"
                                        Click="AddProfile_Click" />

                                    <Button
                                        Grid.Column="3"
                                        Content="Désactiver"
                                        Click="DeactivateProfile_Click" />
                                </Grid>

                                <!-- Layout PETIT (2 lignes) -->
                                <Grid
                                    x:Name="ProfileRowNarrow"
                                    RowDefinitions="Auto,Auto"
                                    ColumnDefinitions="*,Auto,Auto"
                                    ColumnSpacing="8"
                                    RowSpacing="8"
                                    Visibility="Collapsed">

                                    <ComboBox
                                        Grid.Row="0"
                                        Grid.Column="0"
                                        Grid.ColumnSpan="3"
                                        ItemsSource="{Binding Profiles}"
                                        SelectedItem="{Binding SelectedProfile, Mode=TwoWay}"
                                        DisplayMemberPath="Name"
                                        PlaceholderText="Choisir une configuration..."
                                        MinWidth="220" />

                                    <Button
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Content="Enregistrer sous…"
                                        Click="SaveAs_Click" />

                                    <Button
                                        Grid.Row="1"
                                        Grid.Column="1"
                                        Content="Ajouter"
                                        Click="AddProfile_Click" />

                                    <Button
                                        Grid.Row="1"
                                        Grid.Column="2"
                                        Content="Désactiver"
                                        Click="DeactivateProfile_Click" />
                                </Grid>
                            </Grid>

                            <!-- Fichier Excel -->
                            <StackPanel Spacing="6" HorizontalAlignment="Stretch">
                                <TextBlock Text="Fichier Excel" FontWeight="SemiBold" />

                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" HorizontalAlignment="Stretch">
                                    <TextBox
                                        x:Name="ExcelPathBox"
                                        PlaceholderText="Chemin du fichier Excel..."
                                        Text="{Binding ExcelPathText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        LostFocus="ExcelPath_LostFocus"
                                        HorizontalAlignment="Stretch" />

                                    <Button Grid.Column="1" Content="Parcourir…" Click="BrowseExcel_Click" />
                                </Grid>

                                <TextBlock
                                    Text="{Binding ExcelPathError}"
                                    Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                    Visibility="{Binding ExcelPathError, Converter={StaticResource StringToVisibilityConverter}}" />
                            </StackPanel>

                            <!-- Dossier -->
                            <StackPanel Spacing="6" HorizontalAlignment="Stretch">
                                <TextBlock Text="Dossier" FontWeight="SemiBold" />

                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" HorizontalAlignment="Stretch">
                                    <TextBox
                                        x:Name="FolderPathBox"
                                        PlaceholderText="Chemin du dossier..."
                                        Text="{Binding FolderPathText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        LostFocus="FolderPath_LostFocus"
                                        HorizontalAlignment="Stretch" />

                                    <Button Grid.Column="1" Content="Parcourir…" Click="BrowseFolder_Click" />
                                </Grid>

                                <TextBlock
                                    Text="{Binding FolderPathError}"
                                    Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                    Visibility="{Binding FolderPathError, Converter={StaticResource StringToVisibilityConverter}}" />
                            </StackPanel>
                        </StackPanel>
                    </Expander>
                </Border>

                <!-- Carte : Thème -->
                <Border
                    HorizontalAlignment="Stretch"
                    Padding="16"
                    CornerRadius="12"
                    Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1">

                    <Expander
                        IsExpanded="False"
                        HorizontalAlignment="Stretch"
                        HorizontalContentAlignment="Stretch">

                        <Expander.Header>
                            <!-- + d'air vertical dans le header -->
                            <Border Padding="0,8,0,8">
                                <Grid ColumnDefinitions="Auto,*" VerticalAlignment="Center" HorizontalAlignment="Stretch">
                                    <FontIcon Glyph="&#xE790;" FontSize="18" Margin="0,0,12,0" />

                                    <StackPanel Grid.Column="1" Spacing="4">
                                        <TextBlock Text="Thème" FontSize="18" FontWeight="SemiBold" />
                                        <TextBlock Text="Préférence d'affichage de l'application" Opacity="0.75" />
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </Expander.Header>

                        <StackPanel Spacing="12" Margin="0,12,0,0" HorizontalAlignment="Stretch">
                            <!-- Même proportions internes que Configuration : Grid "*,Auto" -->
                            <!-- Le spacer à droite simule la largeur d’un bouton "Parcourir…" -->
                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" HorizontalAlignment="Stretch">
                                <ComboBox Grid.Column="0" SelectedIndex="{Binding ThemeIndex, Mode=TwoWay}" HorizontalAlignment="Stretch">
                                    <ComboBoxItem Content="Système (par défaut)" />
                                    <ComboBoxItem Content="Clair" />
                                    <ComboBoxItem Content="Sombre" />
                                </ComboBox>

                                <!-- Spacer pour garder la même largeur visuelle que les champs avec bouton -->
                                <Border Grid.Column="1" MinWidth="110" Opacity="0" IsHitTestVisible="False" />
                            </Grid>

                            <TextBlock>
                                <Run Text="Version : " />
                                <Run Text="{Binding AppVersion}" />
                            </TextBlock>

                            <TextBlock Text="{Binding PackageName}" Opacity="0.75" />
                        </StackPanel>
                    </Expander>
                </Border>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Page>
